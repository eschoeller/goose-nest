---
- name: Check if Ollama is installed
  ansible.builtin.command: which ollama
  register: ollama_check
  changed_when: false
  failed_when: false

- name: Get installed Ollama version
  ansible.builtin.shell: ollama --version | grep -oP '[\d.]+'
  register: ollama_installed_version
  changed_when: false
  when: ollama_check.rc == 0

- name: Get latest Ollama version from GitHub
  ansible.builtin.uri:
    url: https://api.github.com/repos/ollama/ollama/releases/latest
    return_content: true
  register: ollama_latest_release
  check_mode: false

- name: Set Ollama version facts
  ansible.builtin.set_fact:
    ollama_current: "{{ ollama_installed_version.stdout | default('none') }}"
    ollama_latest: "{{ (ollama_latest_release.json.tag_name | regex_replace('^v', '')) }}"

- name: Display Ollama version status
  ansible.builtin.debug:
    msg: "Ollama: installed={{ ollama_current }}, latest={{ ollama_latest }}"

- name: Install or upgrade Ollama
  ansible.builtin.shell: curl -fsSL https://ollama.com/install.sh | sh
  when: ollama_check.rc != 0 or ollama_current != ollama_latest
  become: true
  notify: Restart ollama

- name: Create models directory
  ansible.builtin.file:
    path: "{{ ollama_models_dir }}"
    state: directory
    owner: ollama
    group: ollama
    mode: "0755"
  become: true

- name: Create systemd override directory
  ansible.builtin.file:
    path: /etc/systemd/system/ollama.service.d
    state: directory
    mode: "0755"
  become: true

- name: Deploy systemd override for OLLAMA_MODELS path
  ansible.builtin.template:
    src: ollama-override.conf.j2
    dest: /etc/systemd/system/ollama.service.d/override.conf
    mode: "0644"
  become: true
  notify: Restart ollama

- name: Flush handlers to restart Ollama before migration
  ansible.builtin.meta: flush_handlers

- name: Check for existing models at old location
  ansible.builtin.stat:
    path: "{{ ollama_old_models_dir }}"
  register: old_models_dir

- name: Migrate existing models to new location
  ansible.builtin.shell: |
    if [ -d "{{ ollama_old_models_dir }}" ] && [ "$(ls -A {{ ollama_old_models_dir }})" ]; then
      mv {{ ollama_old_models_dir }}/* {{ ollama_models_dir }}/
      chown -R ollama:ollama {{ ollama_models_dir }}
      rm -rf {{ ollama_old_models_dir }}
    fi
  become: true
  when: old_models_dir.stat.exists and old_models_dir.stat.isdir
  register: migration_result
  changed_when: migration_result.rc == 0

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Ensure Ollama service is enabled and running
  ansible.builtin.systemd:
    name: ollama
    state: started
    enabled: true
  become: true
