---
- name: Check nvidia-smi is available
  ansible.builtin.command: which nvidia-smi
  register: nvidia_smi_check
  changed_when: false
  failed_when: nvidia_smi_check.rc != 0
  check_mode: false

- name: Fail if no NVIDIA GPU detected
  ansible.builtin.fail:
    msg: >
      No NVIDIA GPU detected. Ensure NVIDIA drivers are installed
      and nvidia-smi is available in PATH.
  when: nvidia_smi_check.rc != 0

- name: Query GPU information
  ansible.builtin.command:
    argv:
      - nvidia-smi
      - --query-gpu=name,memory.total,driver_version
      - --format=csv,noheader,nounits
  register: gpu_info
  changed_when: false
  check_mode: false

- name: Query CUDA version
  ansible.builtin.shell: "nvidia-smi | grep -oP 'CUDA Version: \\K[\\d.]+'"
  register: cuda_version
  changed_when: false
  check_mode: false

- name: Display GPU information
  ansible.builtin.debug:
    msg: |
      GPU: {{ gpu_info.stdout.split(',')[0] | trim }}
      VRAM: {{ gpu_info.stdout.split(',')[1] | trim }} MiB
      Driver: {{ gpu_info.stdout.split(',')[2] | trim }}
      CUDA: {{ cuda_version.stdout }}
